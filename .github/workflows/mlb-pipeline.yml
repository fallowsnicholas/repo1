name: MLB Pitcher-Batter Correlation Pipeline

on:
  # Trigger via webhook (repository_dispatch)
  repository_dispatch:
    types: [full-pipeline, test-step-1, test-step-2, test-step-3, test-step-4, test-step-5, test-step-6, test-step-7, data-only, parlays-only]
  
  # Manual triggering with comprehensive options
  workflow_dispatch:
    inputs:
      pipeline:
        description: 'Which pipeline to run'
        required: true
        default: 'full-pipeline'
        type: choice
        options:
        - full-pipeline
        - data-only
        - test-step-1
        - test-step-2
        - test-step-3
        - test-step-4
        - test-step-5
        - test-step-6
        - test-step-7
        - parlays-only

jobs:
  mlb-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    # STEP 1: Fetch matchups from ESPN
    - name: "Step 1: Fetch MLB Matchups"
      if: |
        github.event.inputs.pipeline == 'full-pipeline' || 
        github.event.inputs.pipeline == 'data-only' ||
        github.event.inputs.pipeline == 'test-step-1' ||
        github.event_name == 'repository_dispatch' && (github.event.action == 'full-pipeline' || github.event.action == 'test-step-1' || github.event.action == 'data-only')
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Starting Step 1: Fetch MLB Matchups"
        python fetch_matchups.py
        echo "‚úÖ Step 1 complete"
    
    # STEP 2: Fetch Odds API data
    - name: "Step 2: Fetch Odds API Data"
      if: |
        github.event.inputs.pipeline == 'full-pipeline' || 
        github.event.inputs.pipeline == 'data-only' ||
        github.event.inputs.pipeline == 'test-step-2' ||
        github.event_name == 'repository_dispatch' && (github.event.action == 'full-pipeline' || github.event.action == 'test-step-2' || github.event.action == 'data-only')
      env:
        ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Starting Step 2: Fetch Odds API Data"
        python fetch_odds_data.py
        echo "‚úÖ Step 2 complete"
    
    # STEP 3: Fetch Splash Sports data
    - name: "Step 3: Fetch Splash Sports Data"
      if: |
        github.event.inputs.pipeline == 'full-pipeline' || 
        github.event.inputs.pipeline == 'data-only' ||
        github.event.inputs.pipeline == 'test-step-3'
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
        PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
        PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
      run: |
        echo "üéØ Starting Step 3: Fetch Splash Sports Data"
        python fetch_splash.py
        echo "‚úÖ Step 3 complete"
    
    # STEP 4: Match lines
    - name: "Step 4: Match Splash to Odds Lines"
      if: |
        github.event.inputs.pipeline == 'full-pipeline' || 
        github.event.inputs.pipeline == 'data-only' ||
        github.event.inputs.pipeline == 'test-step-4' ||
        github.event_name == 'repository_dispatch' && (github.event.action == 'full-pipeline' || github.event.action == 'test-step-4' || github.event.action == 'data-only')
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Starting Step 4: Match Lines"
        python match_lines.py
        echo "‚úÖ Step 4 complete"
    
    # STEP 5: Calculate EV
    - name: "Step 5: Calculate Expected Values"
      if: |
        github.event.inputs.pipeline == 'full-pipeline' || 
        github.event.inputs.pipeline == 'data-only' ||
        github.event.inputs.pipeline == 'test-step-5' ||
        github.event_name == 'repository_dispatch' && (github.event.action == 'full-pipeline' || github.event.action == 'test-step-5' || github.event.action == 'data-only')
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Starting Step 5: Calculate EV"
        python calculate_ev.py
        echo "‚úÖ Step 5 complete"
    
    # STEP 6: Find pitcher anchors
    - name: "Step 6: Find Pitcher Anchors"
      if: |
        github.event.inputs.pipeline == 'full-pipeline' || 
        github.event.inputs.pipeline == 'test-step-6' ||
        github.event.inputs.pipeline == 'parlays-only' ||
        github.event_name == 'repository_dispatch' && (github.event.action == 'full-pipeline' || github.event.action == 'test-step-6' || github.event.action == 'parlays-only')
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Starting Step 6: Find Pitcher Anchors"
        python find_pitcher_anchors.py
        echo "‚úÖ Step 6 complete"
    
    # STEP 7: Build correlation parlays
    - name: "Step 7: Build Correlation Parlays"
      if: |
        github.event.inputs.pipeline == 'full-pipeline' || 
        github.event.inputs.pipeline == 'test-step-7' ||
        github.event.inputs.pipeline == 'parlays-only' ||
        github.event_name == 'repository_dispatch' && (github.event.action == 'full-pipeline' || github.event.action == 'test-step-7' || github.event.action == 'parlays-only')
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Starting Step 7: Build Correlation Parlays"
        python build_parlays.py
        echo "‚úÖ Step 7 complete"
    
    # PIPELINE SUMMARY
    - name: "Pipeline Summary"
      if: |
        github.event.inputs.pipeline == 'full-pipeline' || 
        github.event_name == 'repository_dispatch' && github.event.action == 'full-pipeline'
      run: |
        echo "üéâ FULL PIPELINE COMPLETE!"
        echo "‚úÖ All 7 steps executed successfully"
        echo "üìä Check Google Sheets for results:"
        echo "   ‚Ä¢ MATCHUPS: Today's games and matchups"
        echo "   ‚Ä¢ ODDS_API: Odds data from multiple sportsbooks"  
        echo "   ‚Ä¢ SPLASH_MLB: Splash Sports props"
        echo "   ‚Ä¢ MATCHED_LINES: Matched props between sources"
        echo "   ‚Ä¢ EV_RESULTS: Expected value opportunities"
        echo "   ‚Ä¢ PITCHER_ANCHORS: Pitcher-based parlay anchors"
        echo "   ‚Ä¢ CORRELATION_PARLAYS: Final pitcher vs batter parlays"

    # Test Bright Data
    - name: "Debug: Test Bright Data Connection"  
      env:
        PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
        PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
      run: |
        echo "üîç Testing Bright Data connection..."
        python brightdata_test.py  
