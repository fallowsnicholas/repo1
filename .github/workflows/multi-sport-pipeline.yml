# .github/workflows/multi-sport-pipeline.yml
name: Multi-Sport Pipeline

on:
  workflow_dispatch:
    inputs:
      sport:
        description: 'Which sport to run'
        required: true
        default: 'MLB'
        type: choice
        options:
        - MLB
        - NFL
        - All Sports
      
      step:
        description: 'Which step(s) to run'
        required: true
        default: 'full-pipeline'
        type: choice
        options:
        - full-pipeline
        - step-1-matchups
        - step-2-odds
        - step-3-splash
        - step-4-match-lines
        - step-5-calculate-ev
        - step-6-find-anchors
        - step-7-build-parlays
        - steps-1-5-data-only
        - steps-6-7-parlays-only
      
      days_offset:
        description: 'Days offset (0=today, 1=tomorrow, -1=yesterday)'
        required: false
        default: '0'
        type: string

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sport: ${{ github.event.inputs.sport == 'All Sports' && fromJSON('["MLB", "NFL"]') || fromJSON(format('["{0}"]', github.event.inputs.sport)) }}
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Display Current Sport
      run: |
        echo "üèà Running pipeline for: ${{ matrix.sport }}"
    
    # STEP 1: Fetch Matchups
    - name: "Step 1: Fetch Matchups"
      if: |
        github.event.inputs.step == 'full-pipeline' || 
        github.event.inputs.step == 'step-1-matchups' ||
        github.event.inputs.step == 'steps-1-5-data-only'
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
        DAYS_OFFSET: ${{ github.event.inputs.days_offset }}
      run: |
        echo "üéØ Step 1: Fetching ${{ matrix.sport }} Matchups"
        echo "üìÖ Days offset: ${{ github.event.inputs.days_offset }}"
        python fetch_matchups.py --sport ${{ matrix.sport }}
        echo "‚úÖ Step 1 complete"
    
    # STEP 2: Fetch Odds
    - name: "Step 2: Fetch Odds API Data"
      if: |
        github.event.inputs.step == 'full-pipeline' || 
        github.event.inputs.step == 'step-2-odds' ||
        github.event.inputs.step == 'steps-1-5-data-only'
      env:
        ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Step 2: Fetching ${{ matrix.sport }} Odds"
        python fetch_odds_data.py --sport ${{ matrix.sport }}
        echo "‚úÖ Step 2 complete"
    
    # STEP 3: Fetch and Process Splash Sports Data (Combined)
    - name: "Step 3: Fetch and Process Splash Sports Data"
      if: |
        github.event.inputs.step == 'full-pipeline' || 
        github.event.inputs.step == 'step-3-splash' ||
        github.event.inputs.step == 'steps-1-5-data-only'
      env:
        SCRAPERAPI_KEY: ${{ secrets.SCRAPERAPI_KEY }}
        SCRAPFLY_KEY: ${{ secrets.SCRAPFLY_KEY }}
        ZENROWS_KEY: ${{ secrets.ZENROWS_KEY }}
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Step 3: Fetching and Processing Splash Sports Data for ${{ matrix.sport }}"
        echo "üì• Step 3A: Fetching JSON..."
        python fetch_splash_json.py --sport ${{ matrix.sport }}
        echo "‚öôÔ∏è Step 3B: Processing and saving to sheets..."
        python process_splash_data.py --sport ${{ matrix.sport }}
        echo "‚úÖ Step 3 complete"
    
    # STEP 4: Match Lines
    - name: "Step 4: Match Splash to Odds Lines"
      if: |
        github.event.inputs.step == 'full-pipeline' || 
        github.event.inputs.step == 'step-4-match-lines' ||
        github.event.inputs.step == 'steps-1-5-data-only'
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Step 4: Matching Lines for ${{ matrix.sport }}"
        python match_lines.py --sport ${{ matrix.sport }}
        echo "‚úÖ Step 4 complete"
    
    # STEP 5: Calculate EV
    - name: "Step 5: Calculate Expected Values"
      if: |
        github.event.inputs.step == 'full-pipeline' || 
        github.event.inputs.step == 'step-5-calculate-ev' ||
        github.event.inputs.step == 'steps-1-5-data-only'
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Step 5: Calculating EV for ${{ matrix.sport }}"
        python calculate_ev.py --sport ${{ matrix.sport }}
        echo "‚úÖ Step 5 complete"
    
    # STEP 6: Find Anchors (MLB only for now)
    - name: "Step 6: Find Anchors"
      if: |
        (github.event.inputs.step == 'full-pipeline' || 
         github.event.inputs.step == 'step-6-find-anchors' ||
         github.event.inputs.step == 'steps-6-7-parlays-only') &&
        matrix.sport == 'MLB'
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Step 6: Finding Anchors for ${{ matrix.sport }}"
        python find_pitcher_anchors.py --sport ${{ matrix.sport }}
        echo "‚úÖ Step 6 complete"
    
    # STEP 7: Build Parlays (MLB only for now)
    - name: "Step 7: Build Correlation Parlays"
      if: |
        (github.event.inputs.step == 'full-pipeline' || 
         github.event.inputs.step == 'step-7-build-parlays' ||
         github.event.inputs.step == 'steps-6-7-parlays-only') &&
        matrix.sport == 'MLB'
      env:
        GOOGLE_SERVICE_ACCOUNT_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS }}
      run: |
        echo "üéØ Step 7: Building Parlays for ${{ matrix.sport }}"
        python build_parlays.py --sport ${{ matrix.sport }}
        echo "‚úÖ Step 7 complete"
    
    # Upload artifacts for debugging
    - name: "Upload artifacts (if available)"
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-artifacts-${{ matrix.sport }}
        path: |
          splash_raw_data.json
          *.log
        retention-days: 7
      continue-on-error: true
    
    # Pipeline Summary
    - name: "Pipeline Summary"
      if: always()
      run: |
        echo "üéâ PIPELINE RUN COMPLETE FOR ${{ matrix.sport }}!"
        echo "Sport: ${{ matrix.sport }}"
        echo "Step: ${{ github.event.inputs.step }}"
        echo ""
        echo "üìä Check Google Sheets for results:"
        echo "   Spreadsheet: ${{ matrix.sport }}_Splash_Data"
        echo ""
        if [ "${{ github.event.inputs.step }}" = "full-pipeline" ]; then
          echo "‚úÖ Full pipeline executed"
        elif [ "${{ github.event.inputs.step }}" = "steps-1-5-data-only" ]; then
          echo "‚úÖ Data collection steps (1-5) executed"
        elif [ "${{ github.event.inputs.step }}" = "steps-6-7-parlays-only" ]; then
          echo "‚úÖ Parlay building steps (6-7) executed"
        else
          echo "‚úÖ Individual step executed"
        fi
